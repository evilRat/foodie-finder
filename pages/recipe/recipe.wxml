<view class="container">
  <!-- å¯¼èˆªæ  -->
  <view class="nav-bar">
    <view class="nav-back" bindtap="goHome">
      <text class="nav-back-icon">â€¹</text>
      <text class="nav-back-text">è¿”å›é¦–é¡µ</text>
    </view>
    <text class="nav-title">{{recipe.name || foodName}}</text>
  </view>

  <!-- åŠ è½½çŠ¶æ€ - éœ€æ±‚6.1: æ˜¾ç¤ºåŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨, éœ€æ±‚6.4: æ˜¾ç¤ºè¿›åº¦æç¤ºæ–‡å­— -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-content">
      <!-- ä¸»è¦åŠ è½½åŠ¨ç”» -->
      <view class="loading-animation">
        <view class="loading-spinner"></view>
        <view class="loading-dots">
          <view class="dot dot1"></view>
          <view class="dot dot2"></view>
          <view class="dot dot3"></view>
        </view>
      </view>
      
      <!-- è¿›åº¦æ¡ - éœ€æ±‚6.1: åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ -->
      <view class="progress-container">
        <view class="progress-bar">
          <view class="progress-fill" style="width: {{loadingProgress}}%"></view>
        </view>
        <text class="progress-text">{{loadingProgress}}%</text>
      </view>
      
      <!-- åŠ è½½ä¿¡æ¯ - éœ€æ±‚6.4: æ˜¾ç¤ºè¿›åº¦æç¤ºæ–‡å­— -->
      <view class="loading-info">
        <text class="loading-text">{{loadingMessage}}</text>
        <text class="loading-tip">AIæ­£åœ¨ä¸ºæ‚¨ç²¾å¿ƒåˆ¶ä½œä¸“ä¸šèœè°±</text>
        <text class="loading-stage">å½“å‰é˜¶æ®µ: {{loadingStage}}</text>
        <text class="loading-food" wx:if="{{foodName}}">æ­£åœ¨ç”Ÿæˆ: {{foodName}}</text>
      </view>
      
      <!-- åŠ è½½é˜¶æ®µæŒ‡ç¤ºå™¨ - éœ€æ±‚6.4: åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­æ˜¾ç¤ºè¿›åº¦æç¤º -->
      <view class="stage-indicators">
        <view class="stage-item {{loadingStage === 'analyzing' ? 'active' : loadingProgress > 15 ? 'completed' : ''}}">
          <view class="stage-icon">ğŸ”</view>
          <text class="stage-label">åˆ†æç‰¹å¾</text>
        </view>
        <view class="stage-item {{loadingStage === 'searching' ? 'active' : loadingProgress > 30 ? 'completed' : ''}}">
          <view class="stage-icon">ğŸ“š</view>
          <text class="stage-label">æŸ¥æ‰¾åšæ³•</text>
        </view>
        <view class="stage-item {{loadingStage === 'generating' ? 'active' : loadingProgress > 50 ? 'completed' : ''}}">
          <view class="stage-icon">ğŸ‘¨â€ğŸ³</view>
          <text class="stage-label">ç”Ÿæˆèœè°±</text>
        </view>
        <view class="stage-item {{loadingStage === 'optimizing' ? 'active' : loadingProgress > 70 ? 'completed' : ''}}">
          <view class="stage-icon">âš¡</view>
          <text class="stage-label">ä¼˜åŒ–æ­¥éª¤</text>
        </view>
        <view class="stage-item {{loadingStage === 'nutrition' ? 'active' : loadingProgress > 85 ? 'completed' : ''}}">
          <view class="stage-icon">ğŸ</view>
          <text class="stage-label">è¥å…»ä¿¡æ¯</text>
        </view>
      </view>
      
      <!-- æ•°æ®æ¥æºæŒ‡ç¤º -->
      <view class="source-indicator" wx:if="{{source}}">
        <text class="source-text">æ•°æ®æ¥æº: {{source === 'search' ? 'æ–‡å­—æœç´¢' : source === 'image' ? 'å›¾ç‰‡è¯†åˆ«' : source === 'cache' ? 'ç¼“å­˜æ•°æ®' : 'é‡æ–°ç”Ÿæˆ'}}</text>
      </view>
    </view>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ - éœ€æ±‚6.2: æ˜¾ç¤ºé”™è¯¯æç¤ºä¿¡æ¯, éœ€æ±‚6.3: æä¾›é‡è¯•åŠŸèƒ½ -->
  <view wx:elif="{{error}}" class="error-container">
    <view class="error-content">
      <view class="error-animation">
        <view class="error-icon">âš ï¸</view>
        <view class="error-waves">
          <view class="wave wave1"></view>
          <view class="wave wave2"></view>
          <view class="wave wave3"></view>
        </view>
      </view>
      
      <!-- é”™è¯¯ä¿¡æ¯ - éœ€æ±‚6.2: æ˜¾ç¤ºé”™è¯¯æç¤ºä¿¡æ¯ -->
      <view class="error-info">
        <text class="error-title">ç”Ÿæˆå¤±è´¥</text>
        <text class="error-message">{{error}}</text>
        <text class="error-tip">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</text>
        <text class="error-food" wx:if="{{foodName}}">èœå“: {{foodName}}</text>
      </view>
      
      <!-- é”™è¯¯æ“ä½œæŒ‰é’® - éœ€æ±‚6.3: æä¾›é‡è¯•åŠŸèƒ½ -->
      <view class="error-actions">
        <button class="action-button retry-button" bindtap="retryGenerate" wx:if="{{retryCount < maxRetries}}">
          <text class="button-icon">ğŸ”„</text>
          <text class="button-text">é‡æ–°ç”Ÿæˆ ({{maxRetries - retryCount}}æ¬¡æœºä¼š)</text>
        </button>
        <button class="action-button search-button" bindtap="searchAgain">
          <text class="button-icon">ğŸ”</text>
          <text class="button-text">é‡æ–°æœç´¢</text>
        </button>
        <button class="action-button back-button" bindtap="goHome">
          <text class="button-icon">ğŸ </text>
          <text class="button-text">è¿”å›é¦–é¡µ</text>
        </button>
      </view>
      
      <!-- é‡è¯•ä¿¡æ¯å’Œé”™è¯¯è¯¦æƒ… -->
      <view class="error-details">
        <view class="retry-info" wx:if="{{retryCount > 0}}">
          <text class="retry-count">å·²é‡è¯• {{retryCount}} æ¬¡</text>
        </view>
        <view class="error-meta" wx:if="{{lastError}}">
          <text class="error-code">é”™è¯¯ä»£ç : {{lastError.code}}</text>
          <text class="error-time">å‘ç”Ÿæ—¶é—´: {{lastError.timestamp}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- èœè°±å†…å®¹ -->
  <view wx:else class="recipe-content">
    <!-- èœè°±åŸºæœ¬ä¿¡æ¯ - éœ€æ±‚4.1: æ˜¾ç¤ºèœè°±çš„åŸºæœ¬ä¿¡æ¯åŒ…æ‹¬çƒ¹é¥ªæ—¶é—´å’Œåˆ¶ä½œéš¾åº¦ -->
    <view class="recipe-header">
      <view class="recipe-title-section">
        <text class="recipe-name">{{recipe.name}}</text>
        <text class="recipe-cuisine" wx:if="{{recipe.cuisine}}">{{recipe.cuisine}}</text>
        <view class="recipe-source-info" wx:if="{{source}}">
          <text class="source-badge">{{source === 'search' ? 'æ–‡å­—æœç´¢' : source === 'image' ? 'å›¾ç‰‡è¯†åˆ«' : source === 'cache' ? 'ç¼“å­˜' : 'ç”Ÿæˆ'}}</text>
        </view>
      </view>
      
      <!-- éœ€æ±‚4.1: æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯åŒ…æ‹¬çƒ¹é¥ªæ—¶é—´å’Œåˆ¶ä½œéš¾åº¦ -->
      <view class="recipe-meta">
        <view class="meta-item">
          <text class="meta-icon">ğŸ•</text>
          <text class="meta-label">çƒ¹é¥ªæ—¶é—´</text>
          <text class="meta-value">{{recipe.cookingTime}}</text>
        </view>
        <view class="meta-item">
          <text class="meta-icon">â­</text>
          <text class="meta-label">éš¾åº¦ç­‰çº§</text>
          <text class="meta-value">{{recipe.difficulty}}</text>
        </view>
        <view class="meta-item">
          <text class="meta-icon">ğŸ‘¥</text>
          <text class="meta-label">ä»½é‡</text>
          <text class="meta-value">{{recipe.servings}}</text>
        </view>
      </view>
      
      <!-- æ•°æ®çŠ¶æ€ä¿¡æ¯ -->
      <view class="recipe-status" wx:if="{{lastUpdated}}">
        <text class="status-text">æ›´æ–°æ—¶é—´: {{lastUpdated}}</text>
        <text class="cache-status" wx:if="{{fromCache}}">æ¥è‡ªç¼“å­˜</text>
      </view>
    </view>

    <!-- é£Ÿææ¸…å• -->
    <view class="section ingredients-section">
      <view class="section-header">
        <text class="section-icon">ğŸ¥¬</text>
        <text class="section-title">é£Ÿææ¸…å•</text>
      </view>
      <view class="ingredients-grid">
        <view class="ingredient-card" wx:for="{{recipe.ingredients}}" wx:key="index">
          <view class="ingredient-main">
            <text class="ingredient-name">{{item.name}}</text>
            <text class="ingredient-amount">{{item.amount}}</text>
          </view>
          <text class="ingredient-note" wx:if="{{item.note}}">{{item.note}}</text>
        </view>
      </view>
    </view>

    <!-- åˆ¶ä½œæ­¥éª¤ -->
    <view class="section steps-section">
      <view class="section-header">
        <text class="section-icon">ğŸ‘¨â€ğŸ³</text>
        <text class="section-title">åˆ¶ä½œæ­¥éª¤</text>
      </view>
      <view class="steps-container">
        <view class="step-card" wx:for="{{recipe.steps}}" wx:key="stepNumber">
          <view class="step-header">
            <view class="step-number">{{item.stepNumber}}</view>
            <text class="step-title">æ­¥éª¤ {{item.stepNumber}}</text>
          </view>
          <text class="step-description">{{item.description}}</text>
          <view class="step-tip" wx:if="{{item.tip}}">
            <text class="tip-icon">ğŸ’¡</text>
            <text class="tip-text">{{item.tip}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- çƒ¹é¥ªè´´å£« -->
    <view class="section tips-section" wx:if="{{recipe.tips && recipe.tips.length > 0}}">
      <view class="section-header">
        <text class="section-icon">ğŸ“</text>
        <text class="section-title">çƒ¹é¥ªè´´å£«</text>
      </view>
      <view class="tips-container">
        <view class="tip-item" wx:for="{{recipe.tips}}" wx:key="index">
          <text class="tip-bullet">â€¢</text>
          <text class="tip-content">{{item}}</text>
        </view>
      </view>
    </view>

    <!-- è¥å…»ä¿¡æ¯ -->
    <view class="section nutrition-section" wx:if="{{recipe.nutrition}}">
      <view class="section-header">
        <text class="section-icon">ğŸ</text>
        <text class="section-title">è¥å…»ä¿¡æ¯</text>
      </view>
      <view class="nutrition-content">
        <view class="nutrition-main-grid">
          <view class="nutrition-item primary">
            <text class="nutrition-label">çƒ­é‡</text>
            <text class="nutrition-value">{{recipe.nutrition.calories}}</text>
          </view>
          <view class="nutrition-item">
            <text class="nutrition-label">è›‹ç™½è´¨</text>
            <text class="nutrition-value">{{recipe.nutrition.protein}}</text>
          </view>
          <view class="nutrition-item">
            <text class="nutrition-label">è„‚è‚ª</text>
            <text class="nutrition-value">{{recipe.nutrition.fat}}</text>
          </view>
          <view class="nutrition-item">
            <text class="nutrition-label">ç¢³æ°´</text>
            <text class="nutrition-value">{{recipe.nutrition.carbs}}</text>
          </view>
        </view>
        
        <!-- è¯¦ç»†è¥å…»ä¿¡æ¯ -->
        <view class="nutrition-detail" wx:if="{{recipe.nutrition.fiber}}">
          <view class="nutrition-row">
            <text class="nutrition-detail-label">è†³é£Ÿçº¤ç»´</text>
            <text class="nutrition-detail-value">{{recipe.nutrition.fiber}}</text>
          </view>
          <view class="nutrition-row">
            <text class="nutrition-detail-label">é’ å«é‡</text>
            <text class="nutrition-detail-value">{{recipe.nutrition.sodium}}</text>
          </view>
          <view class="nutrition-row" wx:if="{{recipe.nutrition.cholesterol}}">
            <text class="nutrition-detail-label">èƒ†å›ºé†‡</text>
            <text class="nutrition-detail-value">{{recipe.nutrition.cholesterol}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å¥åº·åŠŸæ•ˆ -->
    <view class="section health-section" wx:if="{{recipe.healthBenefits && recipe.healthBenefits.length > 0}}">
      <view class="section-header">
        <text class="section-icon">ğŸ’ª</text>
        <text class="section-title">å¥åº·åŠŸæ•ˆ</text>
      </view>
      <view class="health-benefits">
        <view class="benefit-item" wx:for="{{recipe.healthBenefits}}" wx:key="index">
          <text class="benefit-icon">âœ“</text>
          <text class="benefit-text">{{item}}</text>
        </view>
      </view>
    </view>

    <!-- é¥®é£Ÿå»ºè®® -->
    <view class="section dietary-section" wx:if="{{recipe.dietaryAdvice && recipe.dietaryAdvice.length > 0}}">
      <view class="section-header">
        <text class="section-icon">âš•ï¸</text>
        <text class="section-title">é¥®é£Ÿå»ºè®®</text>
      </view>
      <view class="dietary-advice">
        <view class="advice-item" wx:for="{{recipe.dietaryAdvice}}" wx:key="index">
          <text class="advice-icon">âš </text>
          <text class="advice-text">{{item}}</text>
        </view>
      </view>
    </view>

    <!-- èœç³»ç‰¹è‰² -->
    <view class="section cuisine-section" wx:if="{{recipe.cuisineFeatures}}">
      <view class="section-header">
        <text class="section-icon">ğŸ®</text>
        <text class="section-title">{{recipe.cuisine}}ç‰¹è‰²</text>
      </view>
      <view class="cuisine-features">
        <view class="feature-card">
          <view class="feature-item">
            <text class="feature-label">å£å‘³ç‰¹ç‚¹</text>
            <text class="feature-value">{{recipe.cuisineFeatures.characteristics}}</text>
          </view>
          <view class="feature-item" wx:if="{{recipe.cuisineFeatures.spiceLevel}}">
            <text class="feature-label">è¾£åº¦ç­‰çº§</text>
            <text class="feature-value">{{recipe.cuisineFeatures.spiceLevel}}</text>
          </view>
          <view class="feature-item" wx:if="{{recipe.cuisineFeatures.region}}">
            <text class="feature-label">å‘æºåœ°åŒº</text>
            <text class="feature-value">{{recipe.cuisineFeatures.region}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- èœå“æè¿° -->
    <view class="section description-section" wx:if="{{recipe.description}}">
      <view class="section-header">
        <text class="section-icon">ğŸ“–</text>
        <text class="section-title">èœå“ä»‹ç»</text>
      </view>
      <view class="description-content">
        <text class="description-text">{{recipe.description}}</text>
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
    <view class="bottom-actions">
      <button class="action-btn secondary" bindtap="searchAgain">
        <text class="btn-icon">ğŸ”</text>
        <text class="btn-text">é‡æ–°æœç´¢</text>
      </button>
      <button class="action-btn primary" bindtap="goHome">
        <text class="btn-icon">ğŸ </text>
        <text class="btn-text">è¿”å›é¦–é¡µ</text>
      </button>
    </view>
  </view>
</view>